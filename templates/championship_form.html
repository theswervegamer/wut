{% extends "base.html" %}
{% block content %}
  <h2>{{ heading }}</h2>

  <style>
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid var(--line); background:#0b0b0b; border-radius:16px; padding:12px; }
    .label { display:block; font-weight:600; margin:6px 0 4px; }
    input[type=text], select, input[type=number] { width:100%; max-width: 380px; padding:10px 12px; background:#0b0b0b; color:var(--fg); border:1px solid var(--line); border-radius:8px; }
    .two { display:grid; gap:12px; grid-template-columns: repeat(2, minmax(220px, 380px)); }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .muted { color:var(--muted); }
    .photo { width:260px; height:160px; object-fit:contain; border:1px solid var(--line); border-radius:12px; background:#111; }
    .photo-ph { width:260px; height:160px; display:flex; align-items:center; justify-content:center; border:1px dashed var(--line); border-radius:12px; color:var(--muted); }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { text-align:left; padding:8px 10px; border-bottom:1px solid var(--line); }
  </style>

  {% if error %}<p class="error">{{ error }}</p>{% endif %}

  <div class="grid">
    <form class="card" method="post" action="{{ action_url }}" enctype="multipart/form-data">
      <div class="two">
        <div>
          <label class="label">Name</label>
          <input type="text" name="name" value="{{ form.name }}" required>
        </div>
        <div>
          <label class="label">Gender</label>
          <select name="gender">
            <option value="Male"   {% if form.gender=='Male' %}selected{% endif %}>Male</option>
            <option value="Female" {% if form.gender=='Female' %}selected{% endif %}>Female</option>
          </select>
        </div>
        <div>
          <label class="label">Stipulation</label>
          <input type="text" name="stipulation" value="{{ form.stipulation }}" placeholder="e.g., Singles, Royal Rumble, ...">
        </div>
        <div>
          <label class="label">Mode</label>
          <select name="mode">
            <option value="Seasonal" {% if form.mode=='Seasonal' %}selected{% endif %}>Seasonal</option>
            <option value="Ongoing"  {% if form.mode=='Ongoing'  %}selected{% endif %}>Ongoing</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        {% if allow_photo_upload %}
          <label class="label" style="width:100%">Belt Photo</label>
          <input type="file" name="photo" accept="image/*">
          {% if form.photo %}
            <img class="photo" src="{{ form.photo }}" alt="Belt photo">
          {% else %}
            <div class="photo-ph">No photo</div>
          {% endif %}
        {% endif %}
      </div>

      <div class="actions" style="margin-top:10px">
        <button class="btn" type="submit">Save</button>
        <a class="btn" href="/championships">Back</a>
      </div>
    </form>

    {% if champ.mode == 'Seasonal' %}
      {% set st = (champ.stipulation or '')|lower %}
      {% set allow_runnerup = st not in ['royal rumble','elimination chamber','rumble','elimination'] %}

      <div class="card">
        <h3 style="margin:0 0 8px">Seasonal Champions</h3>
        <form class="row" method="post" action="/championship/{{ champ.id }}/season/set">
          <label class="label">Season</label>
          <input type="number" name="season" min="1" value="{{ season }}" required>
          <label class="label">Champion</label>
          <select name="champion_id">
            {% for w in request.app.state._cache_wrestlers_by_gender[champ.gender] %}
              <option value="{{ w.id }}">{{ w.name }}</option>
            {% endfor %}
          </select>

          {% if allow_runnerup %}
            <label class="label">Runner-up (optional)</label>
            <select name="runner_up_id">
              <option value="">— None —</option>
              {% for w in request.app.state._cache_wrestlers_by_gender[champ.gender] %}
                <option value="{{ w.id }}">{{ w.name }}</option>
              {% endfor %}
            </select>
          {% else %}
            <!-- Hidden empty field to always submit something harmless -->
            <input type="hidden" name="runner_up_id" value="">
          {% endif %}

          <button class="btn" type="submit">Set</button>
        </form>

        {% if seasonal_rows %}
          <table>
            <thead><tr><th>Season</th><th>Champion</th><th>Runner-up</th><th></th></tr></thead>
            <tbody>
              {% for r in seasonal_rows %}
                <tr>
                  <td>S{{ r.season }}</td>
                  <td>{{ r.champion }}</td>
                  <td>{{ r.runner_up or '—' }}</td>
                <td>
<form class="inline-form" method="post" action="/championship/{{ champ.id }}/season/delete">
<input type="hidden" name="season" value="{{ r.season }}" />
<button class="btn btn-small btn-danger" type="submit">Delete</button>
</form>
</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted">No seasons recorded yet.</p>
        {% endif %}
      </div>
    {% else %}
      <div class="card">
        <h3 style="margin:0 0 8px">Ongoing Title – Reigns</h3>
        <form class="row" method="post" action="/championship/{{ champ.id }}/reigns/start">
          <label class="label">Champion</label>
          <select name="champion_id" required>
            {% for w in eligible %}
              <option value="{{ w.id }}">{{ w.name }}</option>
            {% endfor %}
          </select>
          <label class="label">Season Won</label>
          <input type="number" name="season_won" min="1" value="{{ season }}" required>
          <label class="label">Champion #</label>
          <input type="number" name="champ_number" min="1" value="{{ next_champ_no }}" placeholder="auto" />
          <button class="btn" type="submit">Start Reign</button>
        </form>

        {% if current_reign %}
          <div class="row" style="margin-top:10px">
            <div><strong>Current:</strong></div>
            <div>{{ current_reign["champion"] }}</div>
            <div class="muted">(Champ #{{ current_reign["champ_number"] }}; S{{ current_reign["season_won"] }})</div>
            <div class="muted">Defences: {{ current_reign["defences"] }}</div>
          </div>
          <div class="actions" style="margin-top:8px">
            <form class="inline-form" method="post" action="/championship/{{ champ.id }}/reigns/increment">
              <button class="btn btn-small" type="submit">+1 Defence</button>
            </form>
            <form class="inline-form" method="post" action="/championship/{{ champ.id }}/reigns/end">
              <label class="label" style="margin:0 6px 0 0">Season Lost</label>
              <input type="number" name="lost_season" min="1" value="{{ season }}" style="width:100px">
              <button class="btn btn-small btn-danger" type="submit">End Reign</button>
            </form>
          </div>
        {% else %}
          <p class="muted" style="margin-top:8px">No active reign.</p>
        {% endif %}

        {% if reign_rows %}
          <table>
            <thead><tr><th>#</th><th>Champion</th><th>Season Won</th><th>Defences</th></tr></thead>
            <tbody>
              {% for r in reign_rows %}
                <tr>
                  <td>{{ r.champ_number or '-' }}</td>
                  <td>{{ r.champion }}</td>
                  <td>S{{ r.season_won or '-' }}</td>
                  <td>{{ r.defences }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted">No past reigns yet.</p>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock %}
